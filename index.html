<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpeg ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ (SharedArrayBufferä¸ä½¿ç”¨)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        .test-section h2 {
            color: #555;
            margin-top: 0;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .file-input {
            margin: 10px 0;
        }
        
        video {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ FFmpeg ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
        <p style="text-align: center; color: #666;">SharedArrayBufferã‚’ä½¿ç”¨ã›ãšã«CDNçµŒç”±ã§FFmpegã‚’èª­ã¿è¾¼ã‚€ãƒ†ã‚¹ãƒˆ</p>
        
        <!-- FFmpegèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>1. FFmpeg ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
            <div id="load-status" class="status loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            <button onclick="testFFmpegLoad()" id="load-btn">å†ãƒ†ã‚¹ãƒˆ</button>
        </div>
        
        <!-- åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>2. FFmpeg åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</h2>
            <div id="init-status" class="status">æœªå®Ÿè¡Œ</div>
            <button onclick="testFFmpegInit()" id="init-btn" disabled>åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</button>
        </div>
        
        <!-- å‹•ç”»å‡¦ç†ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h2>3. å‹•ç”»å‡¦ç†ãƒ†ã‚¹ãƒˆ</h2>
            <div id="process-status" class="status">æœªå®Ÿè¡Œ</div>
            
            <div class="file-input">
                <label for="video-input">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="video-input" accept="video/*">
            </div>
            
            <div>
                <button onclick="createTestVideo()" id="create-btn" disabled>ãƒ†ã‚¹ãƒˆå‹•ç”»ä½œæˆ</button>
                <button onclick="processVideo()" id="process-btn" disabled>å‹•ç”»å‡¦ç†å®Ÿè¡Œ</button>
            </div>
            
            <div class="progress" style="display: none;" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <video id="output-video" controls style="display: none;"></video>
            </div>
        </div>
        
        <!-- ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="test-section">
            <h2>4. å®Ÿè¡Œãƒ­ã‚°</h2>
            <div id="log-area" class="log-area"></div>
            <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <!-- FFmpeg CDNèª­ã¿è¾¼ã¿ -->
    <script type="module">
        // FFmpegã¨Coreã®èª­ã¿è¾¼ã¿
        let FFmpeg, fetchFile, toBlobURL;
        let ffmpeg = null;
        let isLoaded = false;
        let isInitialized = false;

        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('log-area');
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–¢æ•°
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        // ãƒ­ã‚°ã‚¯ãƒªã‚¢é–¢æ•°
        window.clearLog = function() {
            document.getElementById('log-area').textContent = '';
        }

        // FFmpegèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        window.testFFmpegLoad = async function() {
            try {
                updateStatus('load-status', 'loading', 'èª­ã¿è¾¼ã¿ä¸­...');
                log('FFmpegãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...');
                
                // CDNçµŒç”±ã§FFmpegã‚’èª­ã¿è¾¼ã¿
                const FFmpegModule = await import('https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/esm/index.js');
                const UtilModule = await import('https://unpkg.com/@ffmpeg/util@0.12.1/dist/esm/index.js');
                
                FFmpeg = FFmpegModule.FFmpeg;
                fetchFile = UtilModule.fetchFile;
                toBlobURL = UtilModule.toBlobURL;
                
                log('FFmpegãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿å®Œäº†');
                updateStatus('load-status', 'success', 'èª­ã¿è¾¼ã¿æˆåŠŸ');
                
                isLoaded = true;
                document.getElementById('init-btn').disabled = false;
                
            } catch (error) {
                log(`FFmpegèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('load-status', 'error', `èª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`);
                isLoaded = false;
            }
        }

        // FFmpegåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
        window.testFFmpegInit = async function() {
            if (!isLoaded) {
                log('ã‚¨ãƒ©ãƒ¼: FFmpegãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                updateStatus('init-status', 'loading', 'åˆæœŸåŒ–ä¸­...');
                log('FFmpegã®åˆæœŸåŒ–ã‚’é–‹å§‹...');
                
                ffmpeg = new FFmpeg();
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
                ffmpeg.on('progress', ({ progress, time }) => {
                    const progressBar = document.getElementById('progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${progress * 100}%`;
                    }
                    log(`å‡¦ç†é€²è¡Œä¸­: ${Math.round(progress * 100)}% (æ™‚é–“: ${time}Î¼s)`);
                });

                // ãƒ­ã‚°ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
                ffmpeg.on('log', ({ message }) => {
                    log(`FFmpeg: ${message}`);
                });

                // Coreã®CDN URLã‚’å–å¾—
                const coreURL = 'https://wokwi.github.io/ffmpeg.wasm/ffmpeg-core.js';
                const wasmURL = 'https://wokwi.github.io/ffmpeg.wasm/ffmpeg-core.wasm';
                
                // FFmpegã‚’åˆæœŸåŒ–ï¼ˆSharedArrayBufferã‚’ä½¿ç”¨ã—ãªã„ï¼‰
                await ffmpeg.load({
                    coreURL,
                    wasmURL,
                    classWorkerURL: null
                });
                
                log('FFmpegã®åˆæœŸåŒ–å®Œäº†');
                updateStatus('init-status', 'success', 'åˆæœŸåŒ–æˆåŠŸ');
                
                isInitialized = true;
                document.getElementById('create-btn').disabled = false;
                document.getElementById('process-btn').disabled = false;
                
            } catch (error) {
                log(`FFmpegåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('init-status', 'error', `åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
                isInitialized = false;
            }
        }

        // ãƒ†ã‚¹ãƒˆå‹•ç”»ä½œæˆ
        window.createTestVideo = async function() {
            if (!isInitialized) {
                log('ã‚¨ãƒ©ãƒ¼: FFmpegãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                updateStatus('process-status', 'loading', 'ãƒ†ã‚¹ãƒˆå‹•ç”»ã‚’ä½œæˆä¸­...');
                log('ãƒ†ã‚¹ãƒˆå‹•ç”»ã®ä½œæˆã‚’é–‹å§‹...');
                
                document.getElementById('progress-container').style.display = 'block';
                
                // ç°¡å˜ãªãƒ†ã‚¹ãƒˆå‹•ç”»ã‚’ä½œæˆï¼ˆ5ç§’é–“ã®è‰²å¤‰åŒ–ï¼‰
                await ffmpeg.exec([
                    '-f', 'lavfi',
                    '-i', 'testsrc2=duration=5:size=640x480:rate=30',
                    '-c:v', 'libx264',
                    '-pix_fmt', 'yuv420p',
                    'test_output.mp4'
                ]);
                
                // ä½œæˆã•ã‚ŒãŸå‹•ç”»ã‚’å–å¾—
                const fileData = await ffmpeg.readFile('test_output.mp4');
                const videoBlob = new Blob([fileData.buffer], { type: 'video/mp4' });
                const videoURL = URL.createObjectURL(videoBlob);
                
                // å‹•ç”»ã‚’è¡¨ç¤º
                const videoElement = document.getElementById('output-video');
                videoElement.src = videoURL;
                videoElement.style.display = 'block';
                
                log('ãƒ†ã‚¹ãƒˆå‹•ç”»ã®ä½œæˆå®Œäº†');
                updateStatus('process-status', 'success', 'ãƒ†ã‚¹ãƒˆå‹•ç”»ä½œæˆæˆåŠŸ');
                
                document.getElementById('progress-container').style.display = 'none';
                
            } catch (error) {
                log(`ãƒ†ã‚¹ãƒˆå‹•ç”»ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('process-status', 'error', `ä½œæˆå¤±æ•—: ${error.message}`);
                document.getElementById('progress-container').style.display = 'none';
            }
        }

        // å‹•ç”»å‡¦ç†å®Ÿè¡Œ
        window.processVideo = async function() {
            if (!isInitialized) {
                log('ã‚¨ãƒ©ãƒ¼: FFmpegãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const fileInput = document.getElementById('video-input');
            if (!fileInput.files[0]) {
                log('ã‚¨ãƒ©ãƒ¼: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            try {
                updateStatus('process-status', 'loading', 'å‹•ç”»ã‚’å‡¦ç†ä¸­...');
                log('å‹•ç”»å‡¦ç†ã‚’é–‹å§‹...');
                
                document.getElementById('progress-container').style.display = 'block';
                
                const inputFile = fileInput.files[0];
                const inputData = await fetchFile(inputFile);
                
                // å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’FFmpegã«æ›¸ãè¾¼ã¿
                await ffmpeg.writeFile('input.mp4', inputData);
                
                // å‹•ç”»å‡¦ç†ï¼ˆä¾‹ï¼šã‚µã‚¤ã‚ºå¤‰æ›´ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ï¼‰
                await ffmpeg.exec([
                    '-i', 'input.mp4',
                    '-vf', 'scale=640:480',
                    '-c:v', 'libx264',
                    '-crf', '23',
                    '-c:a', 'aac',
                    'output.mp4'
                ]);
                
                // å‡¦ç†ã•ã‚ŒãŸå‹•ç”»ã‚’å–å¾—
                const outputData = await ffmpeg.readFile('output.mp4');
                const outputBlob = new Blob([outputData.buffer], { type: 'video/mp4' });
                const outputURL = URL.createObjectURL(outputBlob);
                
                // å‡¦ç†ã•ã‚ŒãŸå‹•ç”»ã‚’è¡¨ç¤º
                const videoElement = document.getElementById('output-video');
                videoElement.src = outputURL;
                videoElement.style.display = 'block';
                
                log('å‹•ç”»å‡¦ç†å®Œäº†');
                updateStatus('process-status', 'success', 'å‹•ç”»å‡¦ç†æˆåŠŸ');
                
                document.getElementById('progress-container').style.display = 'none';
                
            } catch (error) {
                log(`å‹•ç”»å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus('process-status', 'error', `å‡¦ç†å¤±æ•—: ${error.message}`);
                document.getElementById('progress-container').style.display = 'none';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«FFmpegèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            testFFmpegLoad();
        });
    </script>
</body>
</html>
