<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MathQuill ãƒ†ã‚¹ãƒˆã‚µã‚¤ãƒˆ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
  <style>
    body { 
      font-family: sans-serif; 
      margin: 2em; 
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 1.5em;
    }
    #math-field { 
      min-height: 3em; 
      border: 2px solid #ddd; 
      padding: 1em; 
      width: 100%;
      border-radius: 4px;
      font-size: 18px;
      background: white;
      transition: border-color 0.2s;
    }
    #math-field:focus-within {
      border-color: #4CAF50;
      outline: none;
    }    #hidden-input {
      position: absolute;
      left: -9999px;
      top: -9999px;
      opacity: 0;
      pointer-events: none;
      width: 1px;
      height: 1px;
      font-size: 16px;
      border: none;
      outline: none;
      background: transparent;
    }
    #log { 
      margin-top: 2em; 
      background: #f9f9f9; 
      border: 1px solid #ddd; 
      padding: 1em; 
      height: 300px; 
      overflow-y: auto; 
      border-radius: 4px;
      font-family: monospace;
    }
    .log-entry { 
      font-size: 0.9em; 
      margin-bottom: 0.5em; 
      padding: 2px 0;
      border-bottom: 1px solid #eee;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .log-number {
      color: #666;
      font-weight: bold;
    }
    .log-time {
      color: #888;
    }
    .log-event {
      color: #2196F3;
      font-weight: bold;
    }
    .log-detail {
      color: #333;
    }
    .clear-btn {
      margin-top: 1em;
      padding: 0.5em 1em;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .clear-btn:hover {
      background: #d32f2f;
    }
    @media (max-width: 600px) {
      body { margin: 1em; }
      .container { padding: 1em; }
      #math-field { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ MathQuill æ•°å¼å…¥åŠ›ãƒ†ã‚¹ãƒˆ</h1>
    <div id="math-field"></div>
    <input id="hidden-input" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    
    <h3>ğŸ“Š ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</h3>
    <div id="log"></div>
    <button class="clear-btn" onclick="clearLog()">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
  <script>
    const MQ = MathQuill.getInterface(2);
    const mathFieldSpan = document.getElementById('math-field');
    const logDiv = document.getElementById('log');
    const hiddenInput = document.getElementById('hidden-input');
    
    const mathField = MQ.MathField(mathFieldSpan, {
      spaceBehavesLikeTab: true,
      leftRightIntoCmdGoes: 'up',
      restrictMismatchedBrackets: true,
      supSubsRequireOperand: true,
      charsThatBreakOutOfSupSub: '+-=<>',
      autoSubscriptNumerals: true,
      handlers: {
        edit: function(field) {
          logEvent('edit', `LaTeX: ${field.latex()}`);
        },
        enter: function(field) {
          logEvent('enter', `LaTeX: ${field.latex()}`);
        },
        upOutOf: function(field) {
          logEvent('upOutOf', `LaTeX: ${field.latex()}`);
        },
        downOutOf: function(field) {
          logEvent('downOutOf', `LaTeX: ${field.latex()}`);
        },
        selectOutOf: function(field) {
          logEvent('selectOutOf', `LaTeX: ${field.latex()}`);
        },
        deleteOutOf: function(field) {
          logEvent('deleteOutOf', `LaTeX: ${field.latex()}`);
        }
      }
    });    // ã‚¹ãƒãƒ›å¯¾å¿œ: ã‚¿ãƒƒãƒæ™‚ã®å‡¦ç†
    mathFieldSpan.addEventListener('touchstart', function(e) {
      logEvent('touchstart', 'ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒæ¤œå‡º');
      e.preventDefault();
      // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰MathQuillã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        mathField.focus();
      }, 100);
    });

    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
    mathFieldSpan.addEventListener('click', function(e) {
      logEvent('click', 'ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º');
      e.preventDefault();
      // MathQuillã«ç›´æ¥ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      mathField.focus();
    });    // ã‚¹ãƒãƒ›ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ã‚’ã‚­ãƒ£ãƒƒãƒã™ã‚‹ãŸã‚
    let isComposing = false;
    let inputBuffer = '';
    
    // éš ã—inputã®å†…å®¹ã‚’MathQuillã¸åæ˜ ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰
    hiddenInput.addEventListener('input', function() {
      if (!isComposing && hiddenInput.value) {
        // 1æ–‡å­—ãšã¤å‡¦ç†ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        const newChars = hiddenInput.value.slice(inputBuffer.length);
        if (newChars) {
          logEvent('hiddenInput', `ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…¥åŠ›: "${newChars}"`);
          mathField.write(newChars);
        }
        inputBuffer = hiddenInput.value;
      }
    });

    // IMEå…¥åŠ›ã®é–‹å§‹ã¨çµ‚äº†ã‚’ç›£è¦–
    hiddenInput.addEventListener('compositionstart', function() {
      isComposing = true;
      inputBuffer = hiddenInput.value;
      logEvent('hiddenInput-compositionstart', 'IMEå…¥åŠ›é–‹å§‹');
    });

    hiddenInput.addEventListener('compositionend', function() {
      isComposing = false;
      logEvent('hiddenInput-compositionend', `IMEå…¥åŠ›çµ‚äº†: "${hiddenInput.value}"`);
      // IMEç¢ºå®šæ™‚ã®å‡¦ç†
      const newText = hiddenInput.value.slice(inputBuffer.length);
      if (newText) {
        mathField.write(newText);
      }
      // ãƒãƒƒãƒ•ã‚¡ã‚’ãƒªã‚»ãƒƒãƒˆ
      inputBuffer = '';
      hiddenInput.value = '';
    });    // ã‚¹ãƒãƒ›ã§ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã®ãŸã‚ã€å®šæœŸçš„ã«éš ã—inputã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
    let focusInterval;
    
    mathFieldSpan.addEventListener('focusin', function() {
      logEvent('mathField-focusin', 'MathFieldå†…ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹');
      // ã‚¹ãƒãƒ›ã®å ´åˆã€éš ã—inputã«ã‚‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
      if (isMobile()) {
        clearInterval(focusInterval);
        // ã‚ˆã‚Šé »ç¹ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã‚’å‘ä¸Š
        focusInterval = setInterval(() => {
          if (document.activeElement !== hiddenInput) {
            hiddenInput.focus();
          }
        }, 200);
      }
    });

    mathFieldSpan.addEventListener('focusout', function() {
      logEvent('mathField-focusout', 'MathFieldã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆ');
      clearInterval(focusInterval);
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¢ã‚¦ãƒˆæ™‚ã«æ®‹ã‚Šã®å…¥åŠ›ã‚’å‡¦ç†
      if (hiddenInput.value && !isComposing) {
        const remainingText = hiddenInput.value.slice(inputBuffer.length);
        if (remainingText) {
          logEvent('hiddenInput-focusout', `æ®‹ã‚Šå…¥åŠ›å‡¦ç†: "${remainingText}"`);
          mathField.write(remainingText);
        }
        hiddenInput.value = '';
        inputBuffer = '';
      }
    });

    // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
             ('ontouchstart' in window) || 
             (navigator.maxTouchPoints > 0);
    }

    // ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
    mathFieldSpan.addEventListener('keydown', e => {
      logEvent('keydown', `key: ${e.key !== undefined ? e.key : 'undefined'}, code: ${e.code || 'undefined'}`);
    });

    mathFieldSpan.addEventListener('keyup', e => {
      logEvent('keyup', `key: ${e.key !== undefined ? e.key : 'undefined'}`);
    });

    mathFieldSpan.addEventListener('input', e => {
      logEvent('input', 'input event fired');
    });

    mathFieldSpan.addEventListener('focus', e => {
      logEvent('focus', 'MathField focused');
    });

    mathFieldSpan.addEventListener('blur', e => {
      logEvent('blur', 'MathField blurred');
    });

    mathFieldSpan.addEventListener('compositionstart', e => {
      logEvent('compositionstart', 'IME composition started');
    });

    mathFieldSpan.addEventListener('compositionend', e => {
      logEvent('compositionend', `IME composition ended: "${e.data || ''}"`);
    });    // éš ã—inputã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ç›£è¦–
    hiddenInput.addEventListener('focus', e => {
      logEvent('hiddenInput-focus', 'éš ã—inputãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹');
    });

    hiddenInput.addEventListener('blur', e => {
      logEvent('hiddenInput-blur', 'éš ã—inputãŒãƒ–ãƒ©ãƒ¼');
      // ãƒ–ãƒ©ãƒ¼æ™‚ã«æ®‹ã‚Šã®å…¥åŠ›ãŒã‚ã‚Œã°å‡¦ç†
      if (hiddenInput.value && !isComposing) {
        const remainingText = hiddenInput.value.slice(inputBuffer.length);
        if (remainingText) {
          logEvent('hiddenInput-blur-process', `ãƒ–ãƒ©ãƒ¼æ™‚å‡¦ç†: "${remainingText}"`);
          mathField.write(remainingText);
        }
        hiddenInput.value = '';
        inputBuffer = '';
      }
      
      // ã‚¹ãƒãƒ›ã®å ´åˆã€çŸ­æ™‚é–“å¾Œã«MathQuillã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
      if (isMobile()) {
        setTimeout(() => {
          mathField.focus();
        }, 10);
      }
    });    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚‚éš ã—inputã§ç›£è¦–
    hiddenInput.addEventListener('keydown', e => {
      logEvent('hiddenInput-keydown', `key: ${e.key || 'undefined'}, code: ${e.code || 'undefined'}`);
      
      // Backspaceãªã©ã®ç‰¹æ®Šã‚­ãƒ¼ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‡¦ç†
      if (e.key === 'Backspace' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Backspace');
        logEvent('hiddenInput-backspace', 'ãƒãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¹å‡¦ç†');
      } else if (e.key === 'Enter' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Enter');
        logEvent('hiddenInput-enter', 'ã‚¨ãƒ³ã‚¿ãƒ¼å‡¦ç†');
      } else if (e.key === 'ArrowLeft' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Left');
        logEvent('hiddenInput-arrow', 'å·¦çŸ¢å°å‡¦ç†');
      } else if (e.key === 'ArrowRight' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Right');
        logEvent('hiddenInput-arrow', 'å³çŸ¢å°å‡¦ç†');
      } else if (e.key === 'ArrowUp' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Up');
        logEvent('hiddenInput-arrow', 'ä¸ŠçŸ¢å°å‡¦ç†');
      } else if (e.key === 'ArrowDown' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Down');
        logEvent('hiddenInput-arrow', 'ä¸‹çŸ¢å°å‡¦ç†');
      }
    });

    let logCount = 0;
    function logEvent(type, detail) {
      logCount++;
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-number">${logCount}.</span> <span class="log-time">[${new Date().toLocaleTimeString()}]</span> <span class="log-event">${type}</span>: <span class="log-detail">${detail}</span>`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      logDiv.innerHTML = '';
      logCount = 0;
      logEvent('system', 'ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
    logEvent('system', 'MathQuillåˆæœŸåŒ–å®Œäº†');
  </script>
</body>
</html>
