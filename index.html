<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MathQuill ãƒ†ã‚¹ãƒˆã‚µã‚¤ãƒˆ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
  <style>
    body { 
      font-family: sans-serif; 
      margin: 2em; 
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 1.5em;
    }
    #math-field { 
      min-height: 3em; 
      border: 2px solid #ddd; 
      padding: 1em; 
      width: 100%;
      border-radius: 4px;
      font-size: 18px;
      background: white;
      transition: border-color 0.2s;
    }
    #math-field:focus-within {
      border-color: #4CAF50;
      outline: none;
    }
    #hidden-input {
      position: absolute;
      left: -9999px;
      top: -9999px;
      opacity: 0;
      pointer-events: none;
    }
    #log { 
      margin-top: 2em; 
      background: #f9f9f9; 
      border: 1px solid #ddd; 
      padding: 1em; 
      height: 300px; 
      overflow-y: auto; 
      border-radius: 4px;
      font-family: monospace;
    }
    .log-entry { 
      font-size: 0.9em; 
      margin-bottom: 0.5em; 
      padding: 2px 0;
      border-bottom: 1px solid #eee;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .log-number {
      color: #666;
      font-weight: bold;
    }
    .log-time {
      color: #888;
    }
    .log-event {
      color: #2196F3;
      font-weight: bold;
    }
    .log-detail {
      color: #333;
    }
    .clear-btn {
      margin-top: 1em;
      padding: 0.5em 1em;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .clear-btn:hover {
      background: #d32f2f;
    }
    @media (max-width: 600px) {
      body { margin: 1em; }
      .container { padding: 1em; }
      #math-field { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ MathQuill æ•°å¼å…¥åŠ›ãƒ†ã‚¹ãƒˆ</h1>
    <div id="math-field"></div>
    <input id="hidden-input" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    
    <h3>ğŸ“Š ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°</h3>
    <div id="log"></div>
    <button class="clear-btn" onclick="clearLog()">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
  <script>
    const MQ = MathQuill.getInterface(2);
    const mathFieldSpan = document.getElementById('math-field');
    const logDiv = document.getElementById('log');
    const hiddenInput = document.getElementById('hidden-input');
    
    const mathField = MQ.MathField(mathFieldSpan, {
      spaceBehavesLikeTab: true,
      leftRightIntoCmdGoes: 'up',
      restrictMismatchedBrackets: true,
      supSubsRequireOperand: true,
      charsThatBreakOutOfSupSub: '+-=<>',
      autoSubscriptNumerals: true,
      handlers: {
        edit: function(field) {
          logEvent('edit', `LaTeX: ${field.latex()}`);
        },
        enter: function(field) {
          logEvent('enter', `LaTeX: ${field.latex()}`);
        },
        upOutOf: function(field) {
          logEvent('upOutOf', `LaTeX: ${field.latex()}`);
        },
        downOutOf: function(field) {
          logEvent('downOutOf', `LaTeX: ${field.latex()}`);
        },
        selectOutOf: function(field) {
          logEvent('selectOutOf', `LaTeX: ${field.latex()}`);
        },
        deleteOutOf: function(field) {
          logEvent('deleteOutOf', `LaTeX: ${field.latex()}`);
        }
      }
    });

    // ã‚¹ãƒãƒ›å¯¾å¿œ: ã‚¿ãƒƒãƒæ™‚ã«éš ã—inputã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    mathFieldSpan.addEventListener('touchstart', function() {
      logEvent('touchstart', 'ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒæ¤œå‡º - éš ã—inputã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹');
      hiddenInput.focus();
    });

    // ã‚¯ãƒªãƒƒã‚¯æ™‚ã‚‚éš ã—inputã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆã‚¹ãƒãƒ›ãƒ»PCä¸¡å¯¾å¿œï¼‰
    mathFieldSpan.addEventListener('click', function() {
      logEvent('click', 'ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º');
      hiddenInput.focus();
    });

    // éš ã—inputã®å†…å®¹ã‚’MathQuillã¸åæ˜ 
    hiddenInput.addEventListener('input', function() {
      if (hiddenInput.value) {
        logEvent('hiddenInput', `å…¥åŠ›å€¤: "${hiddenInput.value}"`);
        mathField.write(hiddenInput.value);
        hiddenInput.value = '';
        // MathQuillã®focusã‚‚ç¶­æŒ
        mathField.focus();
      }
    });

    // ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
    mathFieldSpan.addEventListener('keydown', e => {
      logEvent('keydown', `key: ${e.key !== undefined ? e.key : 'undefined'}, code: ${e.code || 'undefined'}`);
    });

    mathFieldSpan.addEventListener('keyup', e => {
      logEvent('keyup', `key: ${e.key !== undefined ? e.key : 'undefined'}`);
    });

    mathFieldSpan.addEventListener('input', e => {
      logEvent('input', 'input event fired');
    });

    mathFieldSpan.addEventListener('focus', e => {
      logEvent('focus', 'MathField focused');
    });

    mathFieldSpan.addEventListener('blur', e => {
      logEvent('blur', 'MathField blurred');
    });

    mathFieldSpan.addEventListener('compositionstart', e => {
      logEvent('compositionstart', 'IME composition started');
    });

    mathFieldSpan.addEventListener('compositionend', e => {
      logEvent('compositionend', `IME composition ended: "${e.data || ''}"`);
    });

    // éš ã—inputã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ç›£è¦–
    hiddenInput.addEventListener('focus', e => {
      logEvent('hiddenInput-focus', 'éš ã—inputãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹');
    });

    hiddenInput.addEventListener('blur', e => {
      logEvent('hiddenInput-blur', 'éš ã—inputãŒãƒ–ãƒ©ãƒ¼');
    });

    let logCount = 0;
    function logEvent(type, detail) {
      logCount++;
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-number">${logCount}.</span> <span class="log-time">[${new Date().toLocaleTimeString()}]</span> <span class="log-event">${type}</span>: <span class="log-detail">${detail}</span>`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      logDiv.innerHTML = '';
      logCount = 0;
      logEvent('system', 'ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // åˆæœŸåŒ–å®Œäº†ãƒ­ã‚°
    logEvent('system', 'MathQuillåˆæœŸåŒ–å®Œäº†');
  </script>
</body>
</html>
