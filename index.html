<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MathQuill „ÉÜ„Çπ„Éà„Çµ„Ç§„Éà</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
  <style>
    body { 
      font-family: sans-serif; 
      margin: 2em; 
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 1.5em;
    }
    #math-field { 
      min-height: 3em; 
      border: 2px solid #ddd; 
      padding: 1em; 
      width: 100%;
      border-radius: 4px;
      font-size: 18px;
      background: white;
      transition: border-color 0.2s;
    }
    #math-field:focus-within {
      border-color: #4CAF50;
      outline: none;
    }    #hidden-input {
      position: absolute;
      left: -9999px;
      top: -9999px;
      opacity: 0;
      pointer-events: none;
      width: 1px;
      height: 1px;
      font-size: 16px;
      border: none;
      outline: none;
      background: transparent;
    }
    #log { 
      margin-top: 2em; 
      background: #f9f9f9; 
      border: 1px solid #ddd; 
      padding: 1em; 
      height: 300px; 
      overflow-y: auto; 
      border-radius: 4px;
      font-family: monospace;
    }
    .log-entry { 
      font-size: 0.9em; 
      margin-bottom: 0.5em; 
      padding: 2px 0;
      border-bottom: 1px solid #eee;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .log-number {
      color: #666;
      font-weight: bold;
    }
    .log-time {
      color: #888;
    }
    .log-event {
      color: #2196F3;
      font-weight: bold;
    }
    .log-detail {
      color: #333;
    }
    .clear-btn {
      margin-top: 1em;
      padding: 0.5em 1em;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .clear-btn:hover {
      background: #d32f2f;
    }
    @media (max-width: 600px) {
      body { margin: 1em; }
      .container { padding: 1em; }
      #math-field { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìê MathQuill Êï∞ÂºèÂÖ•Âäõ„ÉÜ„Çπ„Éà</h1>
    <div id="math-field"></div>
    <input id="hidden-input" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    
    <h3>üìä „Ç§„Éô„É≥„Éà„É≠„Ç∞</h3>
    <div id="log"></div>
    <button class="clear-btn" onclick="clearLog()">„É≠„Ç∞„Çí„ÇØ„É™„Ç¢</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
  <script>
    const MQ = MathQuill.getInterface(2);
    const mathFieldSpan = document.getElementById('math-field');
    const logDiv = document.getElementById('log');
    const hiddenInput = document.getElementById('hidden-input');
    
    const mathField = MQ.MathField(mathFieldSpan, {
      spaceBehavesLikeTab: true,
      leftRightIntoCmdGoes: 'up',
      restrictMismatchedBrackets: true,
      supSubsRequireOperand: true,
      charsThatBreakOutOfSupSub: '+-=<>',
      autoSubscriptNumerals: true,
      handlers: {
        edit: function(field) {
          logEvent('edit', `LaTeX: ${field.latex()}`);
        },
        enter: function(field) {
          logEvent('enter', `LaTeX: ${field.latex()}`);
        },
        upOutOf: function(field) {
          logEvent('upOutOf', `LaTeX: ${field.latex()}`);
        },
        downOutOf: function(field) {
          logEvent('downOutOf', `LaTeX: ${field.latex()}`);
        },
        selectOutOf: function(field) {
          logEvent('selectOutOf', `LaTeX: ${field.latex()}`);
        },
        deleteOutOf: function(field) {
          logEvent('deleteOutOf', `LaTeX: ${field.latex()}`);
        }
      }
    });    // „Çπ„Éû„ÉõÂØæÂøú: „Çø„ÉÉ„ÉÅÊôÇ„ÅÆÂá¶ÁêÜ
    mathFieldSpan.addEventListener('touchstart', function(e) {
      logEvent('touchstart', '„Çπ„Éû„Éõ„Çø„ÉÉ„ÉÅÊ§úÂá∫');
      e.preventDefault();
      // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Åã„ÇâMathQuill„Å´„Éï„Ç©„Éº„Ç´„Çπ
      setTimeout(() => {
        mathField.focus();
      }, 100);
    });

    // „ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÂá¶ÁêÜ
    mathFieldSpan.addEventListener('click', function(e) {
      logEvent('click', '„ÇØ„É™„ÉÉ„ÇØÊ§úÂá∫');
      e.preventDefault();
      // MathQuill„Å´Áõ¥Êé•„Éï„Ç©„Éº„Ç´„Çπ
      mathField.focus();
    });    // „Çπ„Éû„Éõ„ÅÆ„Ç≠„Éº„Éú„Éº„ÉâÂÖ•Âäõ„Çí„Ç≠„É£„ÉÉ„ÉÅ„Åô„Çã„Åü„ÇÅ
    let isComposing = false;
    let inputBuffer = '';
    
    // Èö†„Åóinput„ÅÆÂÜÖÂÆπ„ÇíMathQuill„Å∏ÂèçÊò†Ôºà„É™„Ç¢„É´„Çø„Ç§„É†Ôºâ
    hiddenInput.addEventListener('input', function() {
      if (!isComposing && hiddenInput.value) {
        // 1ÊñáÂ≠ó„Åö„Å§Âá¶ÁêÜ„Åó„Å¶„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
        const newChars = hiddenInput.value.slice(inputBuffer.length);
        if (newChars) {
          logEvent('hiddenInput', `„É™„Ç¢„É´„Çø„Ç§„É†ÂÖ•Âäõ: "${newChars}"`);
          mathField.write(newChars);
        }
        inputBuffer = hiddenInput.value;
      }
    });

    // IMEÂÖ•Âäõ„ÅÆÈñãÂßã„Å®ÁµÇ‰∫Ü„ÇíÁõ£Ë¶ñ
    hiddenInput.addEventListener('compositionstart', function() {
      isComposing = true;
      inputBuffer = hiddenInput.value;
      logEvent('hiddenInput-compositionstart', 'IMEÂÖ•ÂäõÈñãÂßã');
    });

    hiddenInput.addEventListener('compositionend', function() {
      isComposing = false;
      logEvent('hiddenInput-compositionend', `IMEÂÖ•ÂäõÁµÇ‰∫Ü: "${hiddenInput.value}"`);
      // IMEÁ¢∫ÂÆöÊôÇ„ÅÆÂá¶ÁêÜ
      const newText = hiddenInput.value.slice(inputBuffer.length);
      if (newText) {
        mathField.write(newText);
      }
      // „Éê„ÉÉ„Éï„Ç°„Çí„É™„Çª„ÉÉ„Éà
      inputBuffer = '';
      hiddenInput.value = '';
    });    // „Çπ„Éû„Éõ„Åß„ÅÆ„Ç≠„Éº„Éú„Éº„ÉâË°®Á§∫„ÅÆ„Åü„ÇÅ„ÄÅÂÆöÊúüÁöÑ„Å´Èö†„Åóinput„Å´„Éï„Ç©„Éº„Ç´„Çπ„ÇíÂΩì„Å¶„Çã
    let focusInterval;
    
    mathFieldSpan.addEventListener('focusin', function() {
      logEvent('mathField-focusin', 'MathFieldÂÜÖ„Åß„Éï„Ç©„Éº„Ç´„Çπ');
      // „Çπ„Éû„Éõ„ÅÆÂ†¥Âêà„ÄÅÈö†„Åóinput„Å´„ÇÇ„Éï„Ç©„Éº„Ç´„Çπ„ÇíÂΩì„Å¶„Çã
      if (isMobile()) {
        clearInterval(focusInterval);
        // „Çà„ÇäÈ†ªÁπÅ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„É™„Ç¢„É´„Çø„Ç§„É†ÊÄß„ÇíÂêë‰∏ä
        focusInterval = setInterval(() => {
          if (document.activeElement !== hiddenInput) {
            hiddenInput.focus();
          }
        }, 200);
      }
    });

    mathFieldSpan.addEventListener('focusout', function() {
      logEvent('mathField-focusout', 'MathField„Åã„Çâ„Éï„Ç©„Éº„Ç´„Çπ„Ç¢„Ç¶„Éà');
      clearInterval(focusInterval);
      // „Éï„Ç©„Éº„Ç´„Çπ„Ç¢„Ç¶„ÉàÊôÇ„Å´ÊÆã„Çä„ÅÆÂÖ•Âäõ„ÇíÂá¶ÁêÜ
      if (hiddenInput.value && !isComposing) {
        const remainingText = hiddenInput.value.slice(inputBuffer.length);
        if (remainingText) {
          logEvent('hiddenInput-focusout', `ÊÆã„ÇäÂÖ•ÂäõÂá¶ÁêÜ: "${remainingText}"`);
          mathField.write(remainingText);
        }
        hiddenInput.value = '';
        inputBuffer = '';
      }
    });

    // „É¢„Éê„Ç§„É´„Éá„Éê„Ç§„ÇπÂà§ÂÆö
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
             ('ontouchstart' in window) || 
             (navigator.maxTouchPoints > 0);
    }

    // „Åù„ÅÆ‰ªñ„ÅÆ„Ç§„Éô„É≥„ÉàÁõ£Ë¶ñ
    mathFieldSpan.addEventListener('keydown', e => {
      logEvent('keydown', `key: ${e.key !== undefined ? e.key : 'undefined'}, code: ${e.code || 'undefined'}`);
    });

    mathFieldSpan.addEventListener('keyup', e => {
      logEvent('keyup', `key: ${e.key !== undefined ? e.key : 'undefined'}`);
    });

    mathFieldSpan.addEventListener('input', e => {
      logEvent('input', 'input event fired');
    });

    mathFieldSpan.addEventListener('focus', e => {
      logEvent('focus', 'MathField focused');
    });

    mathFieldSpan.addEventListener('blur', e => {
      logEvent('blur', 'MathField blurred');
    });

    mathFieldSpan.addEventListener('compositionstart', e => {
      logEvent('compositionstart', 'IME composition started');
    });

    mathFieldSpan.addEventListener('compositionend', e => {
      logEvent('compositionend', `IME composition ended: "${e.data || ''}"`);
    });    // Èö†„Åóinput„ÅÆ„Ç§„Éô„É≥„Éà„ÇÇÁõ£Ë¶ñ
    hiddenInput.addEventListener('focus', e => {
      logEvent('hiddenInput-focus', 'Èö†„Åóinput„Åå„Éï„Ç©„Éº„Ç´„Çπ');
    });

    hiddenInput.addEventListener('blur', e => {
      logEvent('hiddenInput-blur', 'Èö†„Åóinput„Åå„Éñ„É©„Éº');
      // „Éñ„É©„ÉºÊôÇ„Å´ÊÆã„Çä„ÅÆÂÖ•Âäõ„Åå„ÅÇ„Çå„Å∞Âá¶ÁêÜ
      if (hiddenInput.value && !isComposing) {
        const remainingText = hiddenInput.value.slice(inputBuffer.length);
        if (remainingText) {
          logEvent('hiddenInput-blur-process', `„Éñ„É©„ÉºÊôÇÂá¶ÁêÜ: "${remainingText}"`);
          mathField.write(remainingText);
        }
        hiddenInput.value = '';
        inputBuffer = '';
      }
      
      // „Çπ„Éû„Éõ„ÅÆÂ†¥Âêà„ÄÅÁü≠ÊôÇÈñìÂæå„Å´MathQuill„Å´„Éï„Ç©„Éº„Ç´„Çπ„ÇíÊàª„Åô
      if (isMobile()) {
        setTimeout(() => {
          mathField.focus();
        }, 10);
      }
    });    // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„ÇÇÈö†„Åóinput„ÅßÁõ£Ë¶ñ
    hiddenInput.addEventListener('keydown', e => {
      logEvent('hiddenInput-keydown', `key: ${e.key || 'undefined'}, code: ${e.code || 'undefined'}`);
      
      // Backspace„Å™„Å©„ÅÆÁâπÊÆä„Ç≠„Éº„ÅØ„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÂá¶ÁêÜ
      if (e.key === 'Backspace' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Backspace');
        logEvent('hiddenInput-backspace', '„Éê„ÉÉ„ÇØ„Çπ„Éö„Éº„ÇπÂá¶ÁêÜ');
      } else if (e.key === 'Enter' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Enter');
        logEvent('hiddenInput-enter', '„Ç®„É≥„Çø„ÉºÂá¶ÁêÜ');
      } else if (e.key === 'ArrowLeft' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Left');
        logEvent('hiddenInput-arrow', 'Â∑¶Áü¢Âç∞Âá¶ÁêÜ');
      } else if (e.key === 'ArrowRight' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Right');
        logEvent('hiddenInput-arrow', 'Âè≥Áü¢Âç∞Âá¶ÁêÜ');
      } else if (e.key === 'ArrowUp' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Up');
        logEvent('hiddenInput-arrow', '‰∏äÁü¢Âç∞Âá¶ÁêÜ');
      } else if (e.key === 'ArrowDown' && !isComposing) {
        e.preventDefault();
        mathField.keystroke('Down');
        logEvent('hiddenInput-arrow', '‰∏ãÁü¢Âç∞Âá¶ÁêÜ');
      }
    });

    let logCount = 0;
    function logEvent(type, detail) {
      logCount++;
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-number">${logCount}.</span> <span class="log-time">[${new Date().toLocaleTimeString()}]</span> <span class="log-event">${type}</span>: <span class="log-detail">${detail}</span>`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      logDiv.innerHTML = '';
      logCount = 0;
      logEvent('system', '„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
    }

    // ÂàùÊúüÂåñÂÆå‰∫Ü„É≠„Ç∞
    logEvent('system', 'MathQuillÂàùÊúüÂåñÂÆå‰∫Ü');
  </script>
</body>
</html>
